<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.dfjinxin.modules.price.dao.PssPriceEwarnDao">

    <!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="io.dfjinxin.modules.price.entity.PssPriceEwarnEntity" id="pssPriceEwarnMap">
        <result property="ewarnId" column="ewarn_id"/>
        <result property="commId" column="comm_id"/>
        <result property="ewarnDate" column="ewarn_date"/>
        <result property="statAreaCode" column="stat_area_code"/>
        <result property="pricTypeId" column="pric_type_id"/>
        <result property="ewarnTypeId" column="ewarn_type_id"/>
        <result property="ewarnLevel" column="ewarn_level"/>
        <result property="priValue" column="pri_value"/>
        <result property="priRange" column="pri_range"/>
    </resultMap>

    <!--<select id="queryList" resultMap="pssPriceEwarnMap">
        select ppe.*, pct.comm_name
        from PSS_price_ewarn ppe
        left join pss_comm_total pct on ppe.comm_id = pct.comm_id
        where pct.comm_id in (select comm_id
                      from pss_comm_total
                      where parent_code in (
                          select comm_id
                          from pss_comm_total
                          where parent_code =#{commId}
                          and data_flag=0
                      ))
        and pct.level_code=3
        and pct.data_flag=0
        order by ppe.ewarn_level desc
    </select>-->

    <select id="queryEchartsData" resultMap="pssPriceEwarnMap">
        select ppe.*
        from pss_price_ewarn ppe
        where ppe.comm_id in (
            select wcp.comm_id FROM wp_comm_pri wcp
            WHERE wcp.data_time between #{startDateStr} and #{endDateStr}
            and wcp.comm_id = #{commId}
         )
        and ppe.ewarn_type_id = #{ewarnTypeId}
    </select>

    <select id="queryType3Warn" resultMap="pssPriceEwarnMap">
        select ewarn_id,comm_id,
           stat_area_code,
           pric_type_id,
           ewarn_type_id,
           ewarn_level,
           pri_value,
           pri_range,
           max(ppe.ewarn_date) as ewarn_date
        from pss_price_ewarn ppe
        group by ppe.comm_id
        order by ewarn_date desc;
    </select>


    <select id="queryEwarnlevel" resultType="io.dfjinxin.modules.price.entity.PssPriceEwarnEntity">
        select count(comm_id) as total,ewarn_level elevel from pss_price_ewarn group by ewarn_level
    </select>

    <select id="selectMaxRange" resultType="io.dfjinxin.modules.price.entity.PssPriceEwarnEntity">
        select ppe.*
        from pss_price_ewarn ppe
        where comm_id in (select pcc.comm_id
                  from pss_comm_total pcc
                  where pcc.parent_code = #{commId})
        and ewarn_date = date(#{dateStr})
        order by pri_range desc
        limit 0,1;
    </select>

    <!--<select id="selectMaxDateTimeEntiey" resultType="io.dfjinxin.modules.price.entity.PssPriceEwarnEntity">
       select max(ppe.ewarn_date) as ewarn_date,ppe.pri_value,ppe.comm_id
        FROM pss_price_ewarn ppe where comm_id =#{commId}
    </select>-->

    <select id="queryPriceEwarnByCommId" resultType="io.dfjinxin.modules.price.entity.PssPriceEwarnEntity">
        select * from pss_price_ewarn where comm_id=#{commId} order by ewarn_date desc limit 0,2
    </select>

    <select id="queryPriceEwarnByDate" resultType="io.dfjinxin.modules.price.entity.PssPriceEwarnEntity">
        select * from pss_price_ewarn where comm_id=#{commId}
        and ewarn_date = date(#{dateStr})
        order by pri_range,pri_value desc limit 0,1;
    </select>

    <select id="countEwarn" resultType="map">
        select ewarn_level as ewarnLevel,count(ewarn_level) as total from pss_price_ewarn
        where ewarn_date = date(#{dateStr})
        group by ewarn_level
    </select>


</mapper>
