<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.dfjinxin.modules.price.dao.PssPriceEwarnDao">

    <!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="io.dfjinxin.modules.price.entity.PssPriceEwarnEntity" id="pssPriceEwarnMap">
        <result property="ewarnId" column="ewarn_id"/>
        <result property="commId" column="comm_id"/>
        <result property="ewarnDate" column="ewarn_date"/>
        <result property="statAreaCode" column="stat_area_code"/>
        <result property="pricTypeId" column="pric_type_id"/>
        <result property="ewarnTypeId" column="ewarn_type_id"/>
        <result property="ewarnLevel" column="ewarn_level"/>
        <result property="priValue" column="pri_value"/>
        <result property="priYonyear" column="pri_yonyear"/>
        <result property="priRange" column="pri_range"/>
        <result property="unit" column="unit"/>
    </resultMap>


    <select id="queryEwarnlevel" resultType="io.dfjinxin.modules.price.entity.PssPriceEwarnEntity">
        select count(comm_id) as total,ewarn_level elevel from pss_price_ewarn group by ewarn_level
    </select>

    <select id="selectMaxRange" resultType="map">
       select ppe.*,wp.code_name ewarn_name
        from pss_price_ewarn ppe
				LEFT JOIN wp_ascii_info wp ON wp.code_id = ppe.ewarn_level
        where comm_id in (select pcc.comm_id
                  from pss_comm_total pcc
                  where pcc.parent_code = #{commId})
        and #{dateStr}>= date(ewarn_date)
        order by ewarn_date desc
        limit 0,1;
    </select>

    <select id="getEwarnProvince" resultType="map">
        SELECT t.comm_id,t.stat_area_code,max(t.ewarn_date) ewarn_date
        FROM pss_price_ewarn t
        where t.comm_id = #{p.commId}
        and date(t.ewarn_date) BETWEEN #{p.smaDate} and #{p.emaDate}
        and t.stat_area_code in (
        SELECT w.area_name FROM wp_area_info w WHERE w.area_id BETWEEN 1 AND 32 or w.parent_id BETWEEN 1 AND 32
        )
        <if test="p.upRange != null and p.upRange!= ''">
            and t.pri_range >0
        </if>
        <if test="p.downRange != null and p.downRange!= ''">
            and 0 > t.pri_range
        </if>
        group by t.stat_area_code
    </select>

    <!--<select id="selectMaxDateTimeEntiey" resultType="io.dfjinxin.modules.price.entity.PssPriceEwarnEntity">
       select max(ppe.ewarn_date) as ewarn_date,ppe.pri_value,ppe.comm_id
        FROM pss_price_ewarn ppe where comm_id =#{commId}
    </select>-->

    <!-- <select id="queryPriceEwarnByCommId" resultType="io.dfjinxin.modules.price.entity.PssPriceEwarnEntity">
         select * from pss_price_ewarn where comm_id=#{commId} order by ewarn_date desc limit 0,2
     </select>-->

    <select id="queryPriceEwarnByDate" resultType="io.dfjinxin.modules.price.entity.PssPriceEwarnEntity">
        select * from pss_price_ewarn where comm_id=#{commId}
        and date(ewarn_date) = #{dateStr}
        order by pri_range,pri_value desc limit 0,1;
    </select>

    <select id="countEwarn" resultType="map">
        select ewarn_level as ewarnLevel,count(ewarn_level) as total from pss_price_ewarn
        where date(ewarn_date) = #{dateStr}
        group by ewarn_level
    </select>

    <select id="getAreaPrice" resultType="io.dfjinxin.modules.price.dto.AreaPrice">
    select comm_id as commId , stat_area_code as  areaName, max(pri_value) as price from pss_price_ewarn
     where comm_id = #{commId,jdbcType=VARCHAR}
     <if test="areaName != null and areaName.size() != 0">
        and stat_area_code in
        <foreach collection="areaName" separator=" , " open=" ( " close=" ) " item="item">
        #{item,jdbcType=VARCHAR}
        </foreach>
    </if>
    and ewarn_date <![CDATA[ >= ]]> STR_TO_DATE (#{date,jdbcType=VARCHAR} ,'%Y-%m-%d')
    group by stat_area_code
</select>

<select id="getLastRecordDate" resultType="java.lang.String">
    select STR_TO_DATE(ewarn_date,'%Y-%m-%d') from pss_price_ewarn where comm_id = #{commId,jdbcType=VARCHAR} order by ewarn_date desc limit 1
</select>

<select id="getMaxPro" resultType="java.util.Map">
    SELECT
        t.comm_id,
        p.comm_name,
        t.pri_range,
        t.pri_value,
        t.unit,
        t.ewarn_date,
        t.ewarn_level,
        w.code_name,
        t.pri_yonyear,
        t.stat_area_code
    FROM
        pss_price_ewarn t
        LEFT JOIN pss_comm_total p ON t.comm_id = p.comm_id
        LEFT JOIN wp_ascii_info w ON w.code_id = t.ewarn_level
    WHERE
        t.comm_id = #{commId,jdbcType=VARCHAR}
        AND t.ewarn_date <![CDATA[ >= ]]> STR_TO_DATE (#{format,jdbcType=VARCHAR} ,'%Y-%m-%d')
    ORDER BY
        ABS( t.pri_range ) DESC
        LIMIT 1
</select>

<select id="getCommMessageByCommId" resultType="io.dfjinxin.modules.price.dto.CommMessage">
    SELECT
        n.comm_name AS commName,
        t.stat_area_code AS commArea,
        t.pri_value AS commPrice,
        t.unit AS commUnit,
        t.pri_range AS commRange
    FROM
        pss_price_ewarn t
        LEFT JOIN pss_comm_total n ON n.comm_id = t.comm_id
    WHERE
        t.comm_id = #{commId,jdbcType=VARCHAR}
        AND t.stat_area_code IN ( SELECT w.area_name FROM wp_area_info w WHERE w.area_id BETWEEN 1 AND 32 OR w.parent_id BETWEEN 1 AND 32 )
        AND t.ewarn_date = ( SELECT max( ewarn_date ) FROM pss_price_ewarn WHERE comm_id = #{commId,jdbcType=VARCHAR} )

</select>


</mapper>
