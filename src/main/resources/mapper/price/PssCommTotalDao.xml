<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.dfjinxin.modules.price.dao.PssCommTotalDao">

    <!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="io.dfjinxin.modules.price.entity.PssCommTotalEntity" id="pssCommTotalMap">
        <result property="commId" column="comm_id"/>
        <result property="commName" column="comm_name"/>
        <result property="parentCode" column="parent_code"/>
        <result property="levelCode" column="level_code"/>
        <result property="createTime" column="create_time"/>
        <result property="dataFlag" column="data_flag"/>
    </resultMap>

    <select id="selectSubCommByLevelCode2" resultMap="pssCommTotalMap">
        select c2.*,
        pcc.ewarn_id,
        pcc.index_id as indexId,
        pcc.remarks,
        pcc.conf_id as confId,
        pec.ewarn_name,
        pec.ewarn_type_id as ewarnTypeId
        FROM pss_comm_total c2
        left join pss_comm_conf pcc on c2.comm_id=pcc.comm_id
        left join pss_ewarn_conf pec on pcc.ewarn_id = pec.ewarn_id
        where pcc.del_flag=0 and pec.del_flag=0
        and c2.parent_code = #{parentCode}
        and c2.data_flag=0
        LIMIT #{param.start}, #{param.pageSize}
    </select>

    <select id="selectSubCommCountByLevelCode2" resultType="java.lang.Integer">
        SELECT count(c2.comm_id)
        FROM pss_comm_total c2
        left join pss_comm_conf pcc on c2.comm_id=pcc.comm_id
        left join pss_ewarn_conf pec on pcc.ewarn_id = pec.ewarn_id
        where pcc.del_flag=0 and pec.del_flag=0
        and c2.parent_code = #{parentCode}
        and c2.data_flag=0
    </select>

    <select id="findCommByLevelCode2" resultMap="pssCommTotalMap">
        SELECT c2.*
        FROM pss_comm_total c2
        where c2.parent_code = #{parentCode}
        and c2.data_flag=0
        LIMIT #{param.start}, #{param.pageSize}
    </select>

    <select id="findCommCountByLevelCode2" resultType="java.lang.Integer">
        SELECT count(c2.comm_id)
        FROM pss_comm_total c2
        where c2.parent_code = #{parentCode}
        and c2.data_flag=0
    </select>

    <select id="getType1CommBySubCommId" resultType="io.dfjinxin.modules.price.entity.PssCommTotalEntity">
        select pct.*
        from pss_comm_total pct
        where comm_id in (
            select parent_code
            from pss_comm_total
            where comm_id in (
                select parent_code
                from pss_comm_total
                where comm_id = #{commId}))

    </select>
    <select id="getDistinctSameParentCode" resultType="io.dfjinxin.modules.price.entity.PssCommTotalEntity">
        select distinct parent_code from pss_comm_total
        where comm_id in (#{commIds})
    </select>
    <select id="queryLevel1" parameterType="map" resultType="map">
      SELECT t.comm_id,t.comm_name FROM  pss_comm_total t
      WHERE t.level_code = 0
    </select>
    <select id="queryLevel2" parameterType="map" resultType="map">
        SELECT t.comm_id,t.comm_name,t.parent_code FROM  pss_comm_total t
        WHERE t.level_code = 1
    </select>
    <select id="queryLevel3" parameterType="map" resultType="map">
        SELECT t.comm_id,t.comm_name,t.parent_code FROM  pss_comm_total t
        WHERE t.level_code = 2
    </select>

    <select id="queryPage" parameterType="map" resultType="map">
       SELECT h4.code_id ewarn_type_id,h4.code_name ewarn_type_name,h.comm_id,h.ewarn_id,h3.ewarn_name,h.conf_id,DATE_FORMAT(h.crte_date,'%Y-%m-%d') crte_date,h.index_id,h2.index_name,h.remarks,
        h1.comm_id0,h1.comm_id1,h1.comm_id2,h1.comm_id3,h1.comm_name0,h1.comm_name1,
        h1.comm_name2,h1.comm_name3 , h.area_name
        FROM pss_comm_conf h
        LEFT JOIN (
            SELECT t.parent_code parent_code3,
            t1.comm_id0,t1.comm_id1,t1.comm_id2,t.comm_id comm_id3,t1.comm_name0,t1.comm_name1,t1.comm_name2,t.comm_name comm_name3
             FROM pss_comm_total t
            LEFT JOIN (
                SELECT f.comm_id comm_id2,f.comm_name comm_name2,f.parent_code parent_code2,f1.comm_id0,f1.comm_id1,f1.comm_name0,f1.comm_name1 FROM pss_comm_total f
                LEFT JOIN (
                    SELECT g.comm_id comm_id1,g.comm_name comm_name1,g1.comm_id0,g1.comm_name0 FROM pss_comm_total g
                    LEFT JOIN (
                        SELECT y.comm_id comm_id0,y.comm_name comm_name0 FROM pss_comm_total y
                        WHERE y.level_code = 0
                        AND y.comm_name IS NOT NULL
                    ) g1 ON  g.parent_code = g1.comm_id0
                    WHERE g.level_code = 1
                ) f1 ON f.parent_code = f1.comm_id1
                WHERE f.level_code = 2
            ) t1 ON t.parent_code = t1.comm_id2
            WHERE t.level_code = 3
        ) h1 ON h.comm_id = h1.comm_id3
        LEFT JOIN wp_base_index_info h2 ON h.index_id = h2.index_id
        LEFT JOIN pss_ewarn_conf h3 ON h.ewarn_id = h3.ewarn_id
        LEFT JOIN wp_ascii_info h4 ON h4.code_id = h3.ewarn_type_id
        WHERE h3.ewarn_type_id= 18
        AND h3.ewarn_name IS NOT NULL
        AND h3.ewarn_name != ''
        AND h2.index_name IS NOT NULL
        AND h2.index_name != ''
        AND h1.comm_name0 IS NOT NULL
        AND h1.comm_name0 != ''
        AND h1.comm_name1 IS NOT NULL
        AND h1.comm_name1 != ''
        AND h1.comm_name2 IS NOT NULL
        AND h1.comm_name2 != ''
        AND h1.comm_name3 IS NOT NULL
        AND h1.comm_name3 != ''
        and h.del_flag = 0
        <if test="p.commLevelCode_0 != null and p.commLevelCode_0 != ''">
            AND h1.comm_id0 = #{p.commLevelCode_0}
        </if>
        <if test="p.commLevelCode_1 != null and p.commLevelCode_1 != ''">
            AND h1.comm_id1 = #{p.commLevelCode_1}
        </if>
        <if test="p.commLevelCode_2 != null and p.commLevelCode_2 != ''">
            AND h1.comm_id2 = #{p.commLevelCode_2}
        </if>
        <if test="p.areaName != null and p.areaName != ''">
            and h.area_name  = #{p.areaName}
        </if>
        <if test="p.commLevelCode_3 != null and p.commLevelCode_3 != ''">
            and h1.comm_id3 =  #{p.commLevelCode_3}
        </if>
    </select>


</mapper>
